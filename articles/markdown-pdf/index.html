<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Nabe tests</title>
  <meta name="description" content="Generation tests for nabe-vnext">
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="../../assets/css/style.css">
</head>
<body>
  <header>
    <div class="container">
      <h1><a href="/">nabe</a></h1>
      <h2>pdf.js et génération markdown vers pdf</h2>
    </div>
  </header>
  <div role="main" class="markdown container">
    <!--config
{
  "Title": "pdf.js et génération markdown vers pdf",
  "Author": "Mickael Daniel",
  "Date": "Apr 09 2011 18:00:00 GMT+0100 (CDT)",
  "Categories": "javascript, node",
  "Tags": "javascript, markdown, node, pdf",
  "layout": "main"
}
config-->

<p>Certains sont certainement déjà au courant de l'existence de l'excellent outil de génération pdf écrit purement en JavaScript par James Hall: <a href="http://snapshotmedia.co.uk/blog/jspdf">jsPDF</a> (<a href="https://github.com/MrRio/jsPDF">source</a>).</p>

<p>Un <a href="https://github.com/marak/pdf.js">module node</a> existe également basé essentiellement sur jsPDF effectué par <a href="https://github.com/marak/">Marak</a> permettant de facilement générer des documents pdf avec node. En fait, je suis venu à m'intéresser à ce sujet en cherchant quelque chose me permettant de générer des documents pdf à partir de fichiers markdown. Et je voulais pouvoir le faire aussi bien complètement coté client qu'en environnement node.js.</p>

<h2>jsPDF - pdf.js</h2>

<p>jsPDF est une solution plutôt brillante utilisant <a href="http://fr.wikipedia.org/wiki/PostScript">PostScript</a> (dans sa version 1.3 si je dis pas de bêtise) pour manipuler et générer la sortie pdf. Autrement dit, bravo à James Hall d'avoir écrit cette librairie, cela à du nécessiter de longues heures d'analyse de la spec. Adobe et de coding. Il a permit la possibilité de générer des rapports coté client (ou dans tout environnement JavaScript). Ceci dit, bien que l'API soit plutôt bien faîte, elle dispose de certaines limites dés lors que l'on pousse un peu le besoin.</p>

<p>pdf.js est un module node basé essentiellement sur jsPDF. Ce post et les exemples de codes sont basé sur pdf.js (l'api des deux librairies diffèrent un peu)</p>

<p>L'API est essentiellement composée de:</p>

<ul>
<li><p><code>addImage: function (imageData, format, x, y, w, h) {}</code></p></li>
<li><p><code>addPage: function () {}</code></p></li>
<li><p><code>drawLine: function (x1, y1, x2, y2, weight, style) {}</code></p></li>
<li><p><code>drawRect: function (x, y, w, h, style) {}</code></p></li>
<li><p><code>output: function (type, options) {}</code></p></li>
<li><p><code>setFontSize: function (size) {}</code></p></li>
<li><p><code>setProperties: function (properties) {}</code></p></li>
<li><p><code>text: function (x, y, text) {}</code></p></li>
</ul>

<p>Vous pouvez jouer avec sur la <a href="http://www.maraksquires.com/pdf.js/">démo</a> fournie par pdf.js.</p>

<p>Assez sympa, n'est ce pas? La possibilité de le faire en utilisant que du JavaScript est une perspective super intéressante, permettant une solution de génération de rapport (si l'idée est poussée) entièrement coté client. Bien sûr, le même code et la même librairie pourraient être utilisé coté serveur avec node.</p>

<p>Mais, car il y a un petit mais, la génération d'un rapport demande un peu de programmation et manipulation de l'api. La principale méthode utilisée étant <code>text(x, y, test)</code>. Cela ne pose aucun soucis dans des cas simples, ou effet de démo, mais j'aurais aimé quelque chose me permettant d'automatiquement prendre un texte, idéalement markdown formaté, et d'en générer un fichier pdf. La conversion vers html est déjà très bien faîte par <a href="http://www.showdown.im/">Showdown</a>, il resterait alors à trouver une solution, même basique, pour générer un document pdf en utilsiant jsPDF à partir d'un arbre dom ou string html.</p>

<p>Et, c'est là que ce post revêt un peu plus d'intérêt (parce que bon, suffit de googler <code>pdf js</code> pour trouver ces formidables librairies).</p>

<h2>Markdown!</h2>

<p>Deux problèmes majeurs lors de l'utilisation de jsPDF (après tout une API relativement bas niveau) avec des documents plus évolués:</p>

<ul>
<li><p>Une ligne trop longue (typique d'un paragraphe markdown) pour le format de la page apparaîtra sur une seule ligne, sortant du document. Aucune notion de retour à la ligne automatique.</p></li>
<li><p>Même problème lors des fins de page. jsPDF ne détecte pas automatiquement le dépassement, et un appel à addPage doit être fait explicitement.</p></li>
</ul>

<p>Marak a d'ailleur ouvert un ticket résumant bien ce point: <a href="https://github.com/marak/pdf.js/issues#issue/1"><a href='https://github.com/marak/pdf.js/issues#issue/1'>https://github.com/marak/pdf.js/issues#issue/1</a></a></p>

<blockquote>
  <p>Forcing the user to create a PDF using only Post Script notation is cruel.</p>
</blockquote>

<p>Je confirme, c'est cruel :) Bien que la solution de disposer d'un espèce de <a href="https://github.com/marak/pdf.js/issues#issue/2">moteur de rendu DOM</a> (et qui idéalement utiliserait les css pour la mise en page) semble idéale, ce n'est vraiment pas quelque chose de facile à implémenter.</p>

<p>Mon besoin de départ était de pouvoir générer une sortie PDF en n'utilisant que du texte (markdown formaté) ou un arbre dom, en n'ayant pas à manipuler l'API. Je suis donc venu à adopter une autre approche, basé sur le une variation du <a href="http://www.javascriptworkshop.com/wp-content/uploads/pdf/AnInconvenientAPI.pdf">domWalker de Douglas Crockford</a>.</p>

<p>L'idée fut donc de:</p>

<ul>
<li><p>Générer du markup html à partir d'un texte markdown (showdown utilisé)</p></li>
<li><p>à partir d'un noeud dom, parser son contenu en utilisant firstChild et nextSibling, et pour chaque tag supporté, appeler les bonnes méthodes de l'api de pdf.js en fonction du tag.</p></li>
</ul>

<p>La variété des tags supportés est vraiment limitée: h1, h2, h3, h4, h5, h6, a, p, blockquote, ul, li, code. Il s'agit pour l'instant plus d'un POC (proof of concept) que d'une réelle librairie. Mais je suis plutôt content du résultat et trouvait que cela méritait un petit post. On peut penser à des choses intéressante, comme concevoir des extensions de navigateurs, l'utiliser coté serveur via node.js, ou encore penser à une génération automatique de quelque chose se rapprochant d'un ebook à partir d'une liste de fichiers markdown (qu'on peut d'ailleurs utilisé avec les services github). Bref, vous me voyez venir... En tout cas, ça va me rendre de sacrés services. Pour l'instant, la fonctionnalité est basique mais, avec un peu plus de boulot, on peut penser à un poil plus de configuration sur le rendu et la mise en page utilisé, tout comme arriver à un meilleur support de l'ensemble des tags générés par Markdown. J'aimerais également supprimé la dépendance à jQuery ($.fn.text principalement.)</p>

<h2 id="demo">Démo</h2>

<p>Une démo est accessible <a href="http://mklabs.github.com/pdf.js/markdown/">ici</a>. Il suffit de taper votre texte markdown formaté (ou markup html, showdown le laissera en l'état) et clicker sur le lien permettant la génération pdf. Un nouveau fichier pdf sera généré(dataURIs) que vous pourrez ensuite <code>Right click and save as</code>. Marche encore mieux sous navigateur Webkit où vous pourrez directement ouvrir le fichier.</p>

<p>Pour les curieux, voici un lien vers le <a href="https://github.com/mklabs/pdf.js/tree/markdown-pdf">fork de pdf.js</a> où vous pourrez retrouver les sources. J'ai également ajouté la possibilité de spécifier différentes fonts en modifiant un poil les sources de pdf.js. <a href="https://github.com/marak/pdf.js/issues#issue/3">Pull request</a> envisageable si je trouve le temps de nettoyer un peu le tout (et implémenter la méthode setFont. Pour l'instant, j'ai ajouté la possibilité de spécifier la font à utilisée via <code>doc.text(x, y, text, font)</code> et leur initialisation au niveau de <code>doc.setProperties()</code>).</p>
  </div>
  <footer>
    <div class="container"></div>
  </footer>
  <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if offline -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/libs/jquery-1.7.1.min.js"><\/script>')</script>
  <script src="../../assets/js/app.js"></script>
</body>
</html>